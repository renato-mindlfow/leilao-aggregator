const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
const API_AUTH = import.meta.env.VITE_API_AUTH || '';

export interface Property {
  id: string;
  title: string;
  category: string;
  auction_type: string;
  state: string;
  city: string;
  neighborhood: string | null;
  address: string | null;
  description: string | null;
  area_total: number | null;
  area_privativa: number | null;
  evaluation_value: number | null;
  first_auction_value: number | null;
  first_auction_date: string | null;
  second_auction_value: number | null;
  second_auction_date: string | null;
  discount_percentage: number | null;
  image_url: string | null;
  auctioneer_id: string;
  source_url: string;
  accepts_financing: boolean | null;
  accepts_fgts: boolean | null;
  accepts_installments: boolean | null;
  occupation_status: string | null;
  pending_debts: string | null;
  is_duplicate: boolean;
  original_id: string | null;
}

export interface Auctioneer {
  id: string;
  name: string;
  website: string;
  logo_url: string | null;
  is_active: boolean;
  property_count: number;
  last_scrape: string | null;
  scrape_status: string;
}

export interface PropertiesResponse {
  items: Property[];
  total: number;
  page: number;
  limit: number;
  total_pages: number;
  has_next: boolean;
  has_prev: boolean;
}

export interface Stats {
  total_properties: number;
  unique_properties: number;
  duplicate_properties: number;
  total_auctioneers: number;
  active_auctioneers: number;
  category_counts: Record<string, number>;
  state_counts: Record<string, number>;
}

export interface PropertyFilters {
  page?: number;
  limit?: number;
  state?: string;
  city?: string;
  neighborhood?: string;
  category?: string;
  auction_type?: string;
  min_value?: number;
  max_value?: number;
  min_discount?: number;
  auctioneer_id?: string;
  search?: string;
  include_duplicates?: boolean;
}

async function fetchApi<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
  };
  
  // Add Basic Auth if credentials are provided
  if (API_AUTH) {
    headers['Authorization'] = `Basic ${btoa(API_AUTH)}`;
  }
  
  const response = await fetch(`${API_URL}${endpoint}`, {
    ...options,
    headers: {
      ...headers,
      ...options?.headers,
    },
  });
  
  if (!response.ok) {
    throw new Error(`API Error: ${response.status}`);
  }
  
  return response.json();
}

export async function getProperties(filters: PropertyFilters = {}): Promise<PropertiesResponse> {
  const params = new URLSearchParams();
  
  Object.entries(filters).forEach(([key, value]) => {
    if (value !== undefined && value !== null && value !== '') {
      params.append(key, String(value));
    }
  });
  
  const queryString = params.toString();
  return fetchApi<PropertiesResponse>(`/api/properties${queryString ? `?${queryString}` : ''}`);
}

export async function getProperty(id: string): Promise<Property> {
  return fetchApi<Property>(`/api/properties/${id}`);
}

export async function getAuctioneers(): Promise<Auctioneer[]> {
  return fetchApi<Auctioneer[]>('/api/auctioneers');
}

export async function getStats(): Promise<Stats> {
  return fetchApi<Stats>('/api/stats');
}

export async function getStates(): Promise<string[]> {
  return fetchApi<string[]>('/api/filters/states');
}

export async function getCities(state?: string): Promise<string[]> {
  const params = state ? `?state=${encodeURIComponent(state)}` : '';
  return fetchApi<string[]>(`/api/filters/cities${params}`);
}

export async function getNeighborhoods(state?: string, city?: string): Promise<string[]> {
  const params = new URLSearchParams();
  if (state) params.append('state', state);
  if (city) params.append('city', city);
  const queryString = params.toString();
  return fetchApi<string[]>(`/api/filters/neighborhoods${queryString ? `?${queryString}` : ''}`);
}

export async function getCategories(): Promise<string[]> {
  return fetchApi<string[]>('/api/filters/categories');
}

export async function getAuctionTypes(): Promise<string[]> {
  return fetchApi<string[]>('/api/filters/auction-types');
}

export function formatCurrency(value: number | null): string {
  if (value === null) return 'N/A';
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(value);
}

export function formatDate(dateString: string | null): string {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleDateString('pt-BR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
  });
}

export function formatArea(area: number | null): string {
  if (area === null) return 'N/A';
  return `${area.toLocaleString('pt-BR')} mÂ²`;
}

// Export api object for direct axios-like usage
export const api = {
  get: async <T>(url: string): Promise<{ data: T }> => {
    const data = await fetchApi<T>(url);
    return { data };
  },
};
